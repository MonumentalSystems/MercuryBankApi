name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write

jobs:
  claude-review:
    # Security: only run in MonumentalSystems org — see PIPELINE-SECURITY.md
    if: github.repository_owner == 'MonumentalSystems'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          plugin_marketplaces: |
            https://github.com/anthropics/claude-code.git
            https://github.com/richlander/dotnet-skills.git
          plugins: |
            code-review@claude-code-plugins
            dotnet-skills@richlander-dotnet-skills
          prompt: |
            /code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            IMPORTANT: After completing your review, you MUST post your findings as a comment on the PR using:
            gh pr comment ${{ github.event.pull_request.number }} --body "<your review in markdown>"

            Do NOT rely on sticky comments to post your review — post your review directly via gh pr comment.
            If you need to verify compilation or tests, use dotnet build and dotnet test.
          claude_args: |
            --max-turns 15
            --allowedTools "Bash(gh pr review:*),Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh api:*),Bash(dotnet build*),Bash(dotnet test*)"
